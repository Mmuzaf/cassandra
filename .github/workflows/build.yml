#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

name: Sonar

on:
  push:
    branches:
      - trunk
      - 'cassandra-[0-9]+.[0-9]+'
    paths:
      - 'src/**/*.java'
      - 'test/**/*.java'
  pull_request:
    branches:
      - trunk
      - 'cassandra-[0-9]+.[0-9]+'
    paths:
      - 'src/**/*.java'
      - 'test/**/*.java'

jobs:
  cassandra-artifacts:
    runs-on: ubuntu-latest
    steps:
     - uses: actions/checkout@v3
       with:
         fetch-depth: 0
     - uses: actions/setup-java@v3
       with:
         java-version: '11'
         distribution: temurin
     - name: Setup Ant
       shell: bash
       run: |
          ANT_VERSION=1.10.13
          wget --no-check-certificate --no-cookies http://archive.apache.org/dist/ant/binaries/apache-ant-${ANT_VERSION}-bin.tar.gz \
          && wget --no-check-certificate --no-cookies http://archive.apache.org/dist/ant/binaries/apache-ant-${ANT_VERSION}-bin.tar.gz.sha512 \
          && echo "$(cat apache-ant-${ANT_VERSION}-bin.tar.gz.sha512) apache-ant-${ANT_VERSION}-bin.tar.gz" | sha512sum -c \
          && tar -zvxf apache-ant-${ANT_VERSION}-bin.tar.gz -C /opt/ \
          && ln -s /opt/apache-ant-${ANT_VERSION} /opt/ant \
          && rm -f apache-ant-${ANT_VERSION}-bin.tar.gz \
          && rm -f apache-ant-${ANT_VERSION}-bin.tar.gz.sha512
          update-alternatives --install "/usr/bin/ant" "ant" "/opt/ant/bin/ant" 1 && \
          update-alternatives --set "ant" "/opt/ant/bin/ant"
     - name: Setup Inputs
       shell: bash
       run: |
         if [ "${{ github.event_name }}" == "pull_request" ]; then
           SONAR_OPTS="-Dsonar.pullrequest.branch=${{ github.head_ref }} -Dsonar.pullrequest.base=${{ github.base_ref }} -Dsonar.pullrequest.key=${{ github.event.pull_request.number }}"
         else
           SONAR_OPTS="-Dsonar.branch.name=${{ github.ref_name }}"
         fi
         echo "SONAR_OPTS:     ${SONAR_OPTS}"
         echo "SONAR_OPTS=${SONAR_OPTS}" >> $GITHUB_ENV
     - name: Fetch Cassandra Sources
       # https://community.sonarsource.com/t/sonarcloud-now-not-updating-github-pr-and-checks/6595/17
       run: |
         git fetch --no-tags https://$GITHUB_TOKEN@github.com/apache/cassandra.git +refs/heads/trunk:refs/remotes/origin/trunk
       env:
         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
     - name: Build Cassandra Artifacts
       run: >
         ant sonar 
         ${{ env.SONAR_OPTS }}
         -Dsonar.login=$SONAR_TOKEN
       env:
         SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
